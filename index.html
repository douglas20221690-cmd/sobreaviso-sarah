<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de Sobreaviso Médico</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563EB">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <!-- Ícones -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Bibliotecas para Exportação (Apenas PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        [v-cloak] { display: none; }
        .holiday-bg { background-color: #fee2e2; } /* Vermelho claro */
        .weekend-bg { background-color: #f3f4f6; } /* Cinza claro */
        
        /* Ajustes para impressão e visualização */
        .doctor-chip { 
            transition: all 0.2s; 
            border: 1px solid rgba(0,0,0,0.1);
        }
        .doctor-chip:hover { transform: translateY(-1px); shadow: md; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

<div id="app" v-cloak class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-blue-600 text-white shadow-md p-4 no-print">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="calendar-heart"></i> Gestão de Sobreaviso
            </h1>
            <div class="flex gap-4 items-center">
                <span v-if="user" class="text-sm hidden sm:inline">{{ user.displayName }}</span>
                
                <!-- Botões da Navbar (Só aparecem se logado E autorizado, exceto Logout que aparece sempre que logado) -->
                <button v-if="user && isAuthorized" @click="showSettings = true" class="p-2 hover:bg-blue-700 rounded-full" title="Configurações">
                    <i data-lucide="settings"></i>
                </button>
                <button v-if="user" @click="logout" class="p-2 hover:bg-blue-700 rounded-full" title="Sair">
                    <i data-lucide="log-out"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- CASO 1: Usuário NÃO Logado -->
    <div v-if="!user" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
            <div class="mb-6 text-blue-600 flex justify-center">
                <i data-lucide="activity" size="48" class="w-16 h-16"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Bem-vindo</h2>
            <p class="text-gray-500 mb-6">Acesso restrito a administradores.</p>
            
            <button @click="login" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold flex items-center justify-center gap-2 mb-4">
                <i data-lucide="log-in"></i> Entrar com Google
            </button>

            <!-- Botão de Logout preventivo na tela de login -->
            <button @click="logout" class="text-sm text-gray-400 hover:text-red-500 underline mt-2">
                Limpar sessão / Sair
            </button>
        </div>
    </div>

    <!-- CASO 2: Usuário Logado mas NÃO AUTORIZADO -->
    <div v-else-if="user && !isAuthorized" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center border-l-4 border-red-500">
            <div class="mb-4 text-red-500 flex justify-center">
                <i data-lucide="lock" size="48" class="w-16 h-16"></i>
            </div>
            <h2 class="text-xl font-bold mb-2 text-gray-800">Acesso Negado</h2>
            <p class="text-gray-600 mb-4">
                O e-mail <b>{{ user.email }}</b> não tem permissão para acessar este sistema.
            </p>
            <p class="text-sm text-gray-400 mb-6">Entre em contato com o administrador ou troque de conta.</p>
            
            <button @click="logout" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 font-semibold flex items-center justify-center gap-2">
                <i data-lucide="log-out"></i> Sair e Trocar Conta
            </button>
        </div>
    </div>

    <!-- CASO 3: Usuário Logado E Autorizado (App Principal) -->
    <div v-else class="flex-grow max-w-7xl w-full mx-auto p-4 flex flex-col lg:flex-row gap-6">
        
        <!-- Coluna Esquerda: Controles -->
        <aside class="w-full lg:w-1/4 flex flex-col gap-6 no-print">
            
            <!-- Seletor de Mês -->
            <div class="bg-white p-4 rounded-lg shadow">
                <label class="block text-sm font-medium text-gray-700 mb-1">Mês de Referência</label>
                <input type="month" v-model="currentMonthStr" @change="loadMonthData" class="w-full border rounded p-2">
            </div>

            <!-- Legenda de Códigos -->
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">Legenda de Códigos</h3>
                    <button @click="showSettings = true" class="text-xs text-blue-500 hover:underline">Editar</button>
                </div>
                <div class="space-y-2 text-sm max-h-60 overflow-y-auto">
                    <div v-for="code in codes" :key="code.id" class="flex flex-col border-b pb-1 last:border-0">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-blue-600 bg-blue-50 px-1 rounded">Cod {{ code.code }}</span>
                            <span class="text-xs font-semibold bg-gray-100 px-2 py-0.5 rounded">{{ formatDuration(code.duration) }}</span>
                        </div>
                        <div class="text-gray-600 text-xs ml-1">
                            {{ code.start }} às {{ code.end }}
                            <span v-if="code.start2 && code.end2"> / {{ code.start2 }} às {{ code.end2 }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ajustes Mensais -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-bold text-gray-700 mb-2">Ajuste Mensal (Noturno)</h3>
                <p class="text-xs text-gray-500 mb-3">Marque quem fez plantão noturno este mês (+18h no banco).</p>
                <div class="space-y-2">
                    <div v-for="doc in doctors" :key="doc.id" class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" :style="{ backgroundColor: getDoctorColor(doc.id) }"></div>
                            <span class="text-sm">{{ doc.name }}</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   :checked="getAdjustment(doc.id)" 
                                   @change="toggleAdjustment(doc.id)"
                                   class="sr-only peer">
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Botões Exportar -->
            <div class="flex flex-col gap-2">
                <button @click="exportToPDF" class="w-full bg-red-600 text-white py-2 rounded shadow hover:bg-red-700 flex justify-center gap-2 items-center">
                    <i data-lucide="file-text"></i> Exportar PDF (2 Páginas)
                </button>
            </div>
        </aside>

        <!-- Coluna Direita: Grade -->
        <main class="w-full lg:w-3/4 flex flex-col gap-6">
            
            <!-- Resumo de Horas -->
            <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                <h3 class="font-bold text-lg mb-3">Banco de Horas (Estimado)</h3>
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-600 uppercase">
                        <tr>
                            <th class="px-3 py-2">Médico</th>
                            <th class="px-3 py-2 text-center">Total Mês</th>
                            <th class="px-3 py-2 text-center">Ajuste Noturno</th>
                            <th class="px-3 py-2 text-center font-bold text-blue-700">Total Anual</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="doc in doctors" :key="doc.id" class="border-b hover:bg-gray-50">
                            <td class="px-3 py-2 font-medium flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full" :style="{ backgroundColor: getDoctorColor(doc.id) }"></div>
                                {{ doc.name }}
                            </td>
                            <td class="px-3 py-2 text-center">{{ formatDuration(calculateMonthlyHours(doc.id)) }}</td>
                            <td class="px-3 py-2 text-center text-green-600 font-bold">
                                {{ getAdjustment(doc.id) ? '+18h' : '-' }}
                            </td>
                            <td class="px-3 py-2 text-center font-bold text-blue-700 text-base">
                                {{ formatDuration(calculateAnnualHours(doc.id)) }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Grade da Escala -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <h2 class="font-bold text-xl text-gray-800">Escala: {{ formatMonthYear(currentMonthStr) }}</h2>
                    <span class="text-xs text-gray-500 hidden sm:inline">Clique no dia para marcar Feriado</span>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse" id="scheduleTable">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600">
                                <th class="border p-2 w-16 text-center">Dia</th>
                                <th class="border p-2 w-24 text-center">Semana</th>
                                <th class="border p-2 text-left">Plantões (Código: Médico)</th>
                                <th class="border p-2 w-16 text-center no-print">Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="day in daysInMonth" :key="day.dateStr" 
                                :class="{ 'weekend-bg': day.isWeekend, 'holiday-bg': day.isHoliday }">
                                
                                <td @click="toggleHoliday(day.dateStr)" 
                                    class="border p-2 text-center font-bold cursor-pointer hover:bg-red-100 select-none"
                                    title="Clique para alternar Feriado">
                                    {{ day.day }}
                                </td>
                                
                                <td class="border p-2 text-center text-gray-500 uppercase text-xs">
                                    {{ day.weekDay }}
                                    <span v-if="day.isHoliday" class="block text-red-500 font-bold text-[10px]">FERIADO</span>
                                </td>
                                
                                <td class="border p-2">
                                    <div class="flex flex-wrap gap-2">
                                        <div v-for="(shift, idx) in getShiftsForDay(day.dateStr)" :key="idx" 
                                             class="flex flex-col bg-white border rounded shadow-sm px-2 py-1 min-w-[140px] doctor-chip cursor-pointer"
                                             @click="openEditModal(day.dateStr, idx)"
                                             :style="{ borderLeft: '4px solid ' + getDoctorColor(shift.doctorId) }"
                                             title="Clique para editar">
                                            
                                            <!-- Linha 1: Código e Nome -->
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="font-bold text-gray-700 text-xs bg-gray-100 px-1 rounded">
                                                    Cod {{ shift.codeId }}
                                                </span>
                                                <span class="font-bold text-xs" :style="{ color: getDoctorColor(shift.doctorId) }">
                                                    {{ getDoctorName(shift.doctorId) }}
                                                </span>
                                            </div>

                                            <!-- Linha 2: Detalhes do Horário (NOVO) -->
                                            <div class="text-[10px] text-gray-500 leading-tight">
                                                {{ getShiftTimeDetails(shift.codeId) }}
                                            </div>
                                        </div>
                                    </div>
                                </td>

                                <td class="border p-2 text-center no-print">
                                    <button @click="openAddModal(day.dateStr)" class="bg-blue-100 text-blue-600 p-1.5 rounded hover:bg-blue-200">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Adicionar/Editar Plantão (UNIFICADO) -->
    <div v-if="showAddModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">{{ isEditing ? 'Editar' : 'Adicionar' }} Plantão - {{ formatDateShort(selectedDateToAdd) }}</h3>
                <button v-if="isEditing" @click="deleteShift" class="text-red-500 hover:text-red-700 text-sm flex items-center gap-1">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Excluir
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Código do Plantão</label>
                <select v-model="newShift.codeId" class="w-full border rounded p-2 bg-white">
                    <option v-for="code in codes" :key="code.id" :value="code.code">
                        {{ code.code }} - {{ getCodeDescription(code) }}
                    </option>
                </select>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium mb-1">Médico</label>
                <select v-model="newShift.doctorId" class="w-full border rounded p-2 bg-white">
                    <option v-for="doc in doctors" :key="doc.id" :value="doc.id">
                        {{ doc.name }}
                    </option>
                </select>
            </div>

            <div class="flex justify-end gap-3">
                <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                <button @click="saveShift" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50" :disabled="!newShift.codeId || !newShift.doctorId">
                    {{ isEditing ? 'Salvar Alteração' : 'Adicionar' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Configurações Globais -->
    <div v-if="showSettings" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Configurações</h2>
                <button @click="showSettings = false" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b mb-4">
                <button @click="activeTab = 'doctors'" :class="['px-4 py-2', activeTab === 'doctors' ? 'border-b-2 border-blue-500 font-bold' : '']">Médicos</button>
                <button @click="activeTab = 'codes'" :class="['px-4 py-2', activeTab === 'codes' ? 'border-b-2 border-blue-500 font-bold' : '']">Códigos</button>
            </div>

            <div class="flex-grow overflow-y-auto">
                <!-- Tab: Médicos -->
                <div v-if="activeTab === 'doctors'" class="space-y-4">
                    <div class="flex gap-2">
                        <input v-model="newDoctorName" @keyup.enter="addDoctor" placeholder="Nome do Médico" class="flex-grow border p-2 rounded">
                        <button @click="addDoctor" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Adicionar</button>
                    </div>
                    <ul class="divide-y">
                        <li v-for="(doc, idx) in doctors" :key="doc.id" class="py-2 flex justify-between items-center">
                            <div class="flex items-center gap-2 w-full">
                                <div class="w-4 h-4 rounded-full flex-shrink-0" :style="{ backgroundColor: getDoctorColor(doc.id) }"></div>
                                <input v-model="doc.name" @change="saveGlobalData" class="border-none bg-transparent focus:bg-gray-50 p-1 w-full">
                            </div>
                            <button @click="removeDoctor(idx)" class="text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </li>
                    </ul>
                </div>

                <!-- Tab: Códigos (Novo Layout) -->
                <div v-if="activeTab === 'codes'" class="space-y-4">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-xs text-gray-500">Para códigos com intervalo único, preencha apenas Início/Fim 1.</p>
                        <button @click="resetCodesToDefault" class="text-xs text-red-500 hover:text-red-700 underline" title="Substitui todos os códigos atuais pelos da planilha original">
                            Restaurar Padrão (CSV)
                        </button>
                    </div>
                    
                    <!-- Header -->
                    <div class="grid grid-cols-12 gap-2 text-xs font-bold bg-gray-100 p-2 rounded text-center">
                        <div class="col-span-1">Cód</div>
                        <div class="col-span-2">Início 1</div>
                        <div class="col-span-2">Fim 1</div>
                        <div class="col-span-2 text-blue-600">Início 2 (Op)</div>
                        <div class="col-span-2 text-blue-600">Fim 2 (Op)</div>
                        <div class="col-span-2">Horas</div>
                        <div class="col-span-1">Ação</div>
                    </div>

                    <!-- Input Novo Código -->
                    <div class="grid grid-cols-12 gap-2 items-center bg-blue-50 p-2 rounded">
                        <div class="col-span-1"><input v-model="newCode.code" type="number" class="w-full border p-1 rounded text-center" placeholder="#"></div>
                        <div class="col-span-2"><input v-model="newCode.start" type="time" class="w-full border p-1 rounded"></div>
                        <div class="col-span-2"><input v-model="newCode.end" type="time" class="w-full border p-1 rounded"></div>
                        <div class="col-span-2"><input v-model="newCode.start2" type="time" class="w-full border p-1 rounded"></div>
                        <div class="col-span-2"><input v-model="newCode.end2" type="time" class="w-full border p-1 rounded"></div>
                        <div class="col-span-2"><input v-model="newCode.duration" type="number" class="w-full border p-1 rounded text-center" placeholder="h"></div>
                        <div class="col-span-1 text-center"><button @click="addCode" class="bg-green-600 text-white p-1 rounded"><i data-lucide="plus" class="w-4 h-4"></i></button></div>
                    </div>

                    <!-- Lista de Códigos -->
                    <div v-for="(code, idx) in codes" :key="code.id" class="grid grid-cols-12 gap-2 items-center border-b py-2 text-sm">
                        <div class="col-span-1"><input v-model="code.code" type="number" class="w-full border p-1 rounded text-center" @change="saveGlobalData"></div>
                        <div class="col-span-2"><input v-model="code.start" type="time" class="w-full border p-1 rounded" @change="saveGlobalData"></div>
                        <div class="col-span-2"><input v-model="code.end" type="time" class="w-full border p-1 rounded" @change="saveGlobalData"></div>
                        <div class="col-span-2"><input v-model="code.start2" type="time" class="w-full border p-1 rounded" @change="saveGlobalData"></div>
                        <div class="col-span-2"><input v-model="code.end2" type="time" class="w-full border p-1 rounded" @change="saveGlobalData"></div>
                        <div class="col-span-2"><input v-model="code.duration" type="number" class="w-full border p-1 rounded text-center" @change="saveGlobalData"></div>
                        <div class="col-span-1 text-center"><button @click="removeCode(idx)" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>
                    </div>
                </div>
            </div>

            <!-- Footer com Botão Fechar -->
            <div class="mt-4 pt-4 border-t flex justify-end">
                <button @click="showSettings = false" class="bg-gray-200 text-gray-800 px-6 py-2 rounded hover:bg-gray-300 font-bold">
                    Fechar
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    // Configuração Hardcoded
    const firebaseConfig = {
      apiKey: "AIzaSyACwzDAdMH3PiROTtoGzhnA6XIRBgqTntA",
      authDomain: "sobreaviso-sarah.firebaseapp.com",
      projectId: "sobreaviso-sarah",
      storageBucket: "sobreaviso-sarah.firebasestorage.app",
      messagingSenderId: "742306359168",
      appId: "1:742306359168:web:5344a9b51edd48dd640365"
    };

    createApp({
        setup() {
            // State
            const user = ref(null);
            const db = ref(null);
            const auth = ref(null);
            const currentMonthStr = ref(new Date().toISOString().slice(0, 7)); // YYYY-MM
            const showSettings = ref(false);
            const activeTab = ref('doctors');
            const showAddModal = ref(false);
            const selectedDateToAdd = ref('');
            const allowedEmails = ['douglasrgomes@gmail.com', 'douglas20221690@gmail.com'];

            // Dados
            const doctors = ref([]);
            const codes = ref([]);
            const schedule = ref({});
            const holidays = ref([]);
            const adjustments = ref({});
            const annualTotals = ref({});

            // Paleta de cores para médicos (Vibrantes e Distintas)
            const doctorColors = [
                '#DC2626', '#EA580C', '#D97706', '#65A30D', '#059669', 
                '#0891B2', '#0284C7', '#4F46E5', '#7C3AED', '#C026D3', 
                '#DB2777', '#E11D48', '#57534E', '#4B5563'
            ];

            // Inputs Temporários
            const newDoctorName = ref('');
            // Código agora suporta 2 horários
            const newCode = ref({ code: '', start: '07:00', end: '13:00', start2: '', end2: '', duration: 12 });
            const newShift = ref({ codeId: '', doctorId: '' });
            
            // Controle de Edição
            const isEditing = ref(false);
            const editingIndex = ref(-1);

            const isAuthorized = computed(() => {
                return user.value && allowedEmails.includes(user.value.email);
            });

            // Dados Iniciais (Extraídos da Planilha)
            // Códigos 16 (13h-19h), 17 (vazio), 18 (vazio)
            const defaultCodes = [
                {id: 1, code: 1, start: '07:00', end: '13:00', duration: 6},
                {id: 2, code: 2, start: '15:00', end: '21:00', duration: 6},
                {id: 3, code: 3, start: '07:00', end: '21:00', duration: 14},
                {id: 4, code: 4, start: '21:00', end: '07:00', duration: 10},
                {id: 5, code: 5, start: '07:00', end: '07:00', duration: 24},
                {id: 6, code: 6, start: '15:00', end: '07:00', duration: 16},
                {id: 7, code: 7, start: '07:00', end: '13:00', start2: '21:00', end2: '07:00', duration: 16},
                {id: 8, code: 8, start: '07:00', end: '15:00', duration: 8},
                {id: 9, code: 9, start: '16:00', end: '07:00', duration: 15},
                {id: 10, code: 10, start: '18:00', end: '07:00', duration: 13},
                {id: 11, code: 11, start: '07:00', end: '19:00', duration: 12},
                {id: 12, code: 12, start: '19:00', end: '07:00', duration: 12},
                {id: 13, code: 13, start: '13:15', end: '19:00', duration: 5.75}, // 5h 45min
                {id: 14, code: 14, start: '19:15', end: '07:00', duration: 11.75}, // 11h 45min
                {id: 15, code: 15, start: '07:00', end: '13:00', start2: '19:00', end2: '07:00', duration: 18},
                {id: 16, code: 16, start: '13:00', end: '19:00', duration: 6},
                {id: 17, code: 17, start: '00:00', end: '00:00', duration: 0}, // Placeholder
                {id: 18, code: 18, start: '00:00', end: '00:00', duration: 0}  // Placeholder
            ];

            onMounted(() => {
                initializeFirebase();
                lucide.createIcons();
            });

            watch(user, (newUser) => {
                if (!newUser) {
                    activeTab.value = 'doctors';
                    doctors.value = [];
                    codes.value = [];
                    schedule.value = {};
                }
            });

            // Firebase Logic
            const initializeFirebase = () => {
                try {
                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    auth.value = firebase.auth();
                    db.value = firebase.firestore();
                    
                    auth.value.onAuthStateChanged((u) => {
                        user.value = u;
                        // Modificado: Se tiver usuário E ele for autorizado, carrega dados
                        if (u && allowedEmails.includes(u.email)) {
                            loadGlobalData();
                            loadMonthData();
                            calculateAnnualTotals(); 
                        }
                    });
                } catch (e) {
                    console.error("Erro Firebase", e);
                }
            };

            const login = async () => {
                if(!auth.value) return;
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.value.signInWithPopup(provider);
                } catch (e) {
                    if (user.value || auth.value.currentUser) return; // Ignora falso positivo
                    if (e.code === 'auth/unauthorized-domain') {
                        alert(`ERRO DE DOMÍNIO: Adicione '${window.location.hostname}' no Firebase Console.`);
                    } else if (e.code !== 'auth/internal-error') {
                        alert("Erro no login: " + e.message);
                    }
                }
            };

            const logout = () => {
                if(auth.value) auth.value.signOut();
                user.value = null;
                doctors.value = [];
                codes.value = [];
            };

            // Gerenciamento de Dados
            const loadGlobalData = async () => {
                if (!db.value) return;
                const doc = await db.value.collection('config').doc('main').get();
                if (doc.exists) {
                    const data = doc.data();
                    doctors.value = data.doctors || [];
                    
                    // Se a lista de códigos no banco estiver vazia ou for muito antiga (padrão antigo),
                    // vamos atualizar com os novos defaultCodes, preservando o que já existe se for relevante.
                    // Para simplificar: se não houver códigos, usa o default.
                    if (!data.codes || data.codes.length === 0) {
                        codes.value = defaultCodes;
                        saveGlobalData(); // Salva a nova lista no banco
                    } else {
                        codes.value = data.codes;
                        // Se quiser FORÇAR a atualização dos códigos padrão, descomente abaixo:
                        // Mas cuidado, isso sobrescreve edições manuais do usuário nos códigos.
                        // codes.value = defaultCodes; 
                    }
                } else {
                    // Padrão Inicial
                    doctors.value = [{id: '1', name: 'Médico A'}, {id: '2', name: 'Médico B'}];
                    codes.value = defaultCodes;
                    saveGlobalData();
                }
            };

            const saveGlobalData = async () => {
                if (!db.value) return;
                await db.value.collection('config').doc('main').set({
                    doctors: doctors.value,
                    codes: codes.value
                });
            };

            const loadMonthData = async () => {
                if (!db.value) return;
                const docRef = db.value.collection('schedules').doc(currentMonthStr.value);
                docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        schedule.value = data.schedule || {};
                        holidays.value = data.holidays || [];
                        adjustments.value = data.adjustments || {};
                    } else {
                        schedule.value = {};
                        holidays.value = [];
                        adjustments.value = {};
                    }
                    setTimeout(() => lucide.createIcons(), 100);
                });
                calculateAnnualTotals(); 
            };

            const saveMonthData = async () => {
                if (!db.value) return;
                await db.value.collection('schedules').doc(currentMonthStr.value).set({
                    schedule: schedule.value,
                    holidays: holidays.value,
                    adjustments: adjustments.value
                }, { merge: true });
                calculateAnnualTotals();
            };

            // Lógica Médicos/Códigos
            const addDoctor = () => {
                if (!newDoctorName.value) return;
                doctors.value.push({ id: Date.now().toString(), name: newDoctorName.value });
                newDoctorName.value = '';
                saveGlobalData();
            };

            const removeDoctor = (idx) => {
                doctors.value.splice(idx, 1);
                saveGlobalData();
            };

            const addCode = () => {
                if (!newCode.value.code) return;
                codes.value.push({ ...newCode.value, id: Date.now() });
                saveGlobalData();
                // Reset form
                newCode.value = { code: '', start: '07:00', end: '13:00', start2: '', end2: '', duration: 12 };
            };

            const removeCode = (idx) => {
                codes.value.splice(idx, 1);
                saveGlobalData();
            };
            
            // Função para resetar códigos manualmente, se necessário
             const resetCodesToDefault = () => {
                if(confirm("ATENÇÃO: Isso apagará todos os códigos editados e restaurará a lista original da planilha CSV. Deseja continuar?")) {
                    codes.value = JSON.parse(JSON.stringify(defaultCodes)); // Deep copy para evitar reatividade indesejada na constante
                    saveGlobalData();
                    alert("Códigos restaurados com sucesso!");
                }
            };

            // Cores Automáticas
            const getDoctorColor = (docId) => {
                // Tenta achar o índice do médico para dar uma cor estável
                const index = doctors.value.findIndex(d => d.id === docId);
                if (index >= 0) {
                    return doctorColors[index % doctorColors.length];
                }
                // Fallback para médicos deletados que ainda estão na escala
                return '#9CA3AF';
            };

            // Calendário
            const daysInMonth = computed(() => {
                const [year, month] = currentMonthStr.value.split('-').map(Number);
                const date = new Date(year, month - 1, 1);
                const days = [];
                const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

                while (date.getMonth() === month - 1) {
                    const dateStr = date.toISOString().split('T')[0];
                    const dayOfWeek = date.getDay();
                    days.push({
                        dateStr,
                        day: date.getDate(),
                        weekDay: weekDays[dayOfWeek],
                        isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                        isHoliday: holidays.value.includes(dateStr)
                    });
                    date.setDate(date.getDate() + 1);
                }
                return days;
            });

            const toggleHoliday = (dateStr) => {
                const idx = holidays.value.indexOf(dateStr);
                if (idx > -1) holidays.value.splice(idx, 1);
                else holidays.value.push(dateStr);
                saveMonthData();
            };

            const getShiftsForDay = (dateStr) => schedule.value[dateStr] || [];

            // Abertura do Modal para ADICIONAR (Limpa o form)
            const openAddModal = (dateStr) => {
                selectedDateToAdd.value = dateStr;
                newShift.value = { codeId: '', doctorId: '' };
                isEditing.value = false;
                editingIndex.value = -1;
                showAddModal.value = true;
            };

            // Abertura do Modal para EDITAR (Carrega dados existentes)
            const openEditModal = (dateStr, idx) => {
                selectedDateToAdd.value = dateStr;
                const shift = schedule.value[dateStr][idx];
                newShift.value = { ...shift }; // Copia os dados
                isEditing.value = true;
                editingIndex.value = idx;
                showAddModal.value = true;
            };

            const closeModal = () => {
                showAddModal.value = false;
                isEditing.value = false;
                editingIndex.value = -1;
            };

            const saveShift = () => {
                const date = selectedDateToAdd.value;
                if (!schedule.value[date]) schedule.value[date] = [];
                
                // Validação de Duplicidade (Só se estiver adicionando ou mudando o código na edição)
                if (!isEditing || (isEditing.value && schedule.value[date][editingIndex.value].codeId != newShift.value.codeId)) {
                    const existingShift = schedule.value[date].find(s => s.codeId == newShift.value.codeId);
                    if (existingShift) {
                        alert("Já existe um médico para este código neste dia.");
                        return;
                    }
                }

                if (isEditing.value) {
                    // Edição: Substitui no índice
                    schedule.value[date][editingIndex.value] = { ...newShift.value };
                } else {
                    // Adição: Push no array
                    schedule.value[date].push({ ...newShift.value });
                }

                saveMonthData();
                closeModal();
            };

            const removeShift = (dateStr, idx) => {
                schedule.value[dateStr].splice(idx, 1);
                saveMonthData();
            };

            // Remove o plantão de dentro do modal de edição
            const deleteShift = () => {
                if(confirm("Tem certeza que deseja excluir este plantão?")) {
                    removeShift(selectedDateToAdd.value, editingIndex.value);
                    closeModal();
                }
            };

            // Helpers
            const getDoctorName = (id) => doctors.value.find(d => d.id === id)?.name || '???';
            
            const getShiftTooltip = (codeId) => {
                const c = codes.value.find(c => c.code == codeId);
                return c ? getCodeDescription(c) : '';
            };

            // Nova função para mostrar detalhes na grade
            const getShiftTimeDetails = (codeId) => {
                const c = codes.value.find(c => c.code == codeId);
                if (!c) return '';
                let time = `${c.start}-${c.end}`;
                if (c.start2 && c.end2) time += ` / ${c.start2}-${c.end2}`;
                return `${time} (${formatDuration(c.duration)})`;
            };

            const getCodeDescription = (c) => {
                let desc = `${c.start}-${c.end}`;
                if (c.start2 && c.end2) desc += ` / ${c.start2}-${c.end2}`;
                desc += ` (${formatDuration(c.duration)})`;
                return desc;
            };
            
            const formatDuration = (h) => {
                const hours = Math.floor(h);
                const minutes = Math.round((h - hours) * 60);
                if (minutes > 0) return `${hours}h${minutes}m`;
                return `${hours}h`;
            }

            const toggleAdjustment = (docId) => {
                adjustments.value[docId] = !adjustments.value[docId];
                saveMonthData();
            };
            const getAdjustment = (docId) => !!adjustments.value[docId];

            // Cálculos
            const calculateMonthlyHours = (docId) => {
                let total = 0;
                for (const date in schedule.value) {
                    if(date.startsWith(currentMonthStr.value)) {
                        const shifts = schedule.value[date];
                        shifts.forEach(shift => {
                            if (shift.doctorId === docId) {
                                const code = codes.value.find(c => c.code == shift.codeId);
                                if (code) total += Number(code.duration);
                            }
                        });
                    }
                }
                return total;
            };

            const calculateAnnualTotals = async () => {
                if (!db.value) return;
                const year = currentMonthStr.value.split('-')[0];
                const totals = {};
                const start = `${year}-01`;
                const end = `${year}-12`;
                
                try {
                    const snapshot = await db.value.collection('schedules')
                        .where(firebase.firestore.FieldPath.documentId(), '>=', start)
                        .where(firebase.firestore.FieldPath.documentId(), '<=', end)
                        .get();

                    doctors.value.forEach(d => totals[d.id] = 0);

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const monthSched = data.schedule || {};
                        const monthAdj = data.adjustments || {};

                        Object.values(monthSched).forEach(dayShifts => {
                            dayShifts.forEach(shift => {
                                const code = codes.value.find(c => c.code == shift.codeId);
                                if (code && totals[shift.doctorId] !== undefined) {
                                    totals[shift.doctorId] += Number(code.duration);
                                }
                            });
                        });
                        Object.keys(monthAdj).forEach(docId => {
                            if (monthAdj[docId] && totals[docId] !== undefined) {
                                totals[docId] += 18; // Antes era -= 18
                            }
                        });
                    });
                    annualTotals.value = totals;
                } catch (e) { console.error(e); }
            };

            const calculateAnnualHours = (docId) => annualTotals.value[docId] || 0;
            const formatMonthYear = (str) => { const [y, m] = str.split('-'); return `${m}/${y}`; };
            const formatDateShort = (str) => { if(!str) return ''; const [y, m, d] = str.split('-'); return `${d}/${m}`; };

            // --- EXPORTAÇÃO ---

            const exportToPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // === PÁGINA 1: ESCALA MENSAL ===
                
                // Título
                doc.setFontSize(16);
                doc.text(`Escala de Sobreaviso - ${formatMonthYear(currentMonthStr.value)}`, 14, 20);

                // Tabela Principal
                const tableData = [];
                daysInMonth.value.forEach(day => {
                    const shifts = getShiftsForDay(day.dateStr);
                    const isHol = day.isHoliday ? " (FERIADO)" : "";
                    
                    if (shifts.length === 0) {
                        tableData.push([`${day.day}`, `${day.weekDay}${isHol}`, "-", "-", "-", "-"]);
                    } else {
                        shifts.forEach(shift => {
                            const code = codes.value.find(c => c.code == shift.codeId);
                            const timeStr = code ? getCodeDescription(code) : '-';
                            const docName = getDoctorName(shift.doctorId);
                            tableData.push([`${day.day}`, `${day.weekDay}${isHol}`, code?.code, timeStr, docName]);
                        });
                    }
                });

                doc.autoTable({
                    startY: 30,
                    head: [['Dia', 'Semana', 'Cód', 'Horário', 'Médico']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [37, 99, 235] }
                });

                // === PÁGINA 2: RESUMO ===
                doc.addPage(); // Adiciona quebra de página

                // Título da Página 2
                doc.setFontSize(16);
                doc.text("Resumo Mensal e Anual", 14, 20);
                
                const summaryData = doctors.value.map(d => [
                    d.name,
                    `${formatDuration(calculateMonthlyHours(d.id))}`,
                    getAdjustment(d.id) ? "SIM (+18h)" : "Não",
                    `${formatDuration(calculateAnnualHours(d.id))}`
                ]);

                doc.autoTable({
                    startY: 30,
                    head: [['Médico', 'Total Mês', 'Noturno', 'Total Anual']],
                    body: summaryData,
                    theme: 'striped',
                    headStyles: { fillColor: [22, 163, 74] }
                });

                doc.save(`Escala_${currentMonthStr.value}.pdf`);
            };

            return {
                user, login, logout,
                showSettings, activeTab,
                doctors, newDoctorName, addDoctor, removeDoctor,
                codes, newCode, addCode, removeCode, getDoctorColor,
                currentMonthStr, loadMonthData,
                daysInMonth, toggleHoliday,
                showAddModal, openAddModal, openEditModal, closeModal, selectedDateToAdd, newShift, saveShift, deleteShift, isEditing,
                schedule, getShiftsForDay, getDoctorName, getShiftTooltip, getCodeDescription, getShiftTimeDetails,
                toggleAdjustment, getAdjustment,
                calculateMonthlyHours, calculateAnnualHours,
                formatMonthYear, formatDateShort, exportToPDF,
                isAuthorized, formatDuration, resetCodesToDefault
            };
        }
    }).mount('#app');
</script>

</body>
</html>
